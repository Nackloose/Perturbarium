# **White Paper: gdiff**
### An Opcodeized Git Diff Specification

**Version:** 1.0.0  
**Date:** July 9, 2025  
**Authors:** N Lisowski

---

## 1. Introduction
This document specifies the gdiff format, an opcodeized, plaintext representation of changes to files. While retaining human readability, its primary goal is to provide a more machine-readable structure and offer more nuance and targeted changes compared to the standard text-based diff format, particularly those generated by Git.

## 2. Goals
- Define a structured, plaintext format that provides a machine-readable and granular representation of file changes, going beyond traditional line-based diffs.
- Balance familiarity with existing diff formats for common operations with the flexibility to introduce new, targeted opcodes.
- Retain a degree of human readability for ease of review and understanding.
- Serve as a robust, data-oriented basis for tools and applications to generate, parse, and apply file changes programmatically.

## 3. Non-Goals
- Entirely replacing the standard git diff format (gdiff is an alternative representation). Tooling may be developed to convert between formats.
- Implementing a full git client.
- Handling complex merge conflicts within the gdiff format itself (though it can represent the changes leading to them).

## 4. Concepts
- **Opcode:** A single non-alphanumeric character representing a specific type of change (e.g., `!`, `-`, `@`).
- **Operand:** Data associated with an opcode, provided in plaintext after the opcode character.
- **Patch:** A block of text representing the changes to a single file (or the relationship between two files in cases like renames or copies), beginning with file identification headers (`---` and `+++`).
- **Gdiff Document:** A concatenation of plaintext patches, representing the changes across multiple files.

## 5. Protocol Specification
This section details the specific opcodes, their plaintext operands, and the overall structure of a gdiff document. The document is a sequence of concatenated plaintext patches. Each patch targets a specific file and contains a sequence of opcode lines.

### 5.1 Versioning
A gdiff document should begin with a version line to indicate the specification version it adheres to. The format of the version line is:

`gdiff-version: [major].[minor]`

For this version of the specification, the version is `1.0`. Parsers should read this line first to understand the expected format of the rest of the document. Documents without a version line could be treated as an assumed default version (e.g., 1.0) or flagged as an error.

### 5.2 Patch Structure
A patch begins with file identification headers (`---` and `+++`). These headers are used to identify the file(s) being changed.

To align with common diff formats used in version control systems like Git for traditional file operations (modify/add, delete, move/rename, copy), these headers *will* include `a/` and `b/` prefixes. The `a/` prefix conventionally indicates the "before" state or source file path, and the `b/` prefix indicates the "after" state or destination file path. This convention is adopted in gdiff headers for these specific operation types to leverage user familiarity with existing diff tools.

For modify/add patches, which represent changes to a single file from a "before" to an "after" state, both `---` and `+++` lines will typically refer to the same file path, prefixed with `a/` and `b/` respectively.

For file-level operations like Delete (`X`), Move/Rename (`<`), or Copy (`+`), the opcode character may optionally be integrated directly into the `---` header line, replacing the first hyphen (`-`). The format becomes `Opcode-- [path]`. In these cases, the path on the `Opcode--` line will be prefixed with `a/` (representing the source or before state), and the path on the `+++` line (if present) will be prefixed with `b/` (representing the destination or after state).

Crucially, paths provided as operands within the body of the patch (e.g., the source file path in the `&` opcode for copying from another file) should *not* include `a/` or `b/` prefixes. These internal paths are relative to the repository root unless otherwise specified and follow gdiff's internal conventions rather than external diff formats.

Examples of Header Structures:

Standard Patch (Modify/Add):
`--- a/path/to/file.txt`
`+++ b/path/to/file.txt`

Delete File:
`X-- a/path/to/file_to_delete.txt`
(The `+++ b//dev/null` line is optional but recommended if desired for clarity, implying deletion to non-existence)

Move/Rename File:
`<-- a/old/path/file.txt`
`+++ b/new/location/file.txt` (Both `---` and `+++` lines are required)

Copy File:
`+-- a/source/file.txt`
`+++ b/destination/file.txt` (Both `---` and `+++` lines are required)

When an opcode is integrated into the header, a separate opcode line for that specific file-level action in the body of the patch is not needed (and would typically be redundant).

Optionally, a context line similar to `@@ -old_start,old_count +new_start,new_count @@ [context]` may follow, though its parsing and use is implementation-dependent and primarily for human readability.

Following the headers (and optional context line), a sequence of opcode lines represents the changes to the file. Each opcode line starts with a single non-alphanumeric opcode character.

### 5.3 Opcodes

Below is a summary table of all defined opcodes:

| Opcode | Name/Action                | Operand Format / Header Integration         | Description                                                      | Example(s)                                   |
|--------|----------------------------|---------------------------------------------|------------------------------------------------------------------|----------------------------------------------|
| `!`    | Add Line                   | `[Line Number]:[Line Content]`              | Insert a new line before the given line number                   | `!5:This is a new line`                      |
| `-`    | Delete Line(s)             | `[Start Line Number],[Count]`               | Delete a number of lines starting from the given line            | `-10,3`                                      |
| `@`    | Modify Line                | `[Line Number]:[New Line Content]`          | Replace the content of a line                                    | `@7:Modified content here`                   |
| `X`    | Delete File                | None (standalone) or `X--` in header        | Delete the specified file                                        | `X` or `X-- a/path/to/delete.txt`            |
| `[`    | Append to Start            | `[Content to prepend]`                      | Prepend content to the beginning of the file                     | `[Header line 1\\nHeader line 2`             |
| `]`    | Append to End              | `[Content to append]`                       | Append content to the end of the file                            | `]Footer line 1\\nFooter line 2`             |
| `<`    | Move/Rename File           | `[Old]:[New]` (standalone) or `<--` header  | Move or rename a file                                            | `<old.txt:new.txt` or `<-- a/old.txt`        |
| `=`    | Copy Block from Original   | `[Orig Start],[Count]:[Insert Line]`        | Copy block from original file version                            | `=20,10:5`                                   |
| `&`    | Copy Block from Another    | `[Src Path]:[Src Start],[Count]:[Insert]`   | Copy block from another file                                     | `&src.txt:15,10:5`                           |
| `(`    | Delete Lines from Start    | `[Count]`                                   | Delete lines from the beginning of the file                      | `(5`                                         |
| `)`    | Delete Lines from End      | `[Count]`                                   | Delete lines from the end of the file                            | `)3`                                         |
| `+`    | Copy File                  | `[Src]:[Dest]` (standalone) or `+--` header | Copy a file to a new location                                    | `+a.txt:b.txt` or `+-- a/a.txt`              |

Here are the details:

#### 5.3.1 Add Line
- **Opcode Character:** `!`
- **Operands:** `[Line Number]:[Line Content]`
    - `Line Number`: The 1-indexed line number *before* which the new line should be inserted. Lines are shifted down after insertion.
    - `Line Content`: The content of the line to add. Colons within content may need escaping or a defined escape mechanism.
- **Example:** `!5:This is a new line` (Insert "This is a new line" before the current 5th line).
- **Description:** Inserts a new line with the specified content before the given line number in the target file.

#### 5.3.2 Delete Line(s)
- **Opcode Character:** `-`
- **Operands:** `[Start Line Number],[Count]`
    - `Start Line Number`: The 1-indexed line number of the first line to delete.
    - `Count`: The number of lines to delete starting from `Start Line Number`. A count of `1` deletes only the specified line.
- **Example:** `-10,3` (Delete 3 lines starting from the current 10th line).
- **Description:** Deletes a specified number of lines starting from the `Start Line Number`.

#### 5.3.3 Modify Line
- **Opcode Character:** `@`
- **Operands:** `[Line Number]:[New Line Content]`
    - `Line Number`: The 1-indexed line number of the line to modify.
    - `New Line Content`: The new content for the specified line. Colons within content may need escaping.
- **Example:** `@7:Modified content here` (Replace the content of the current 7th line with "Modified content here").
- **Description:** Replaces the content of the line at `Line Number` with `New Line Content`.

#### 5.3.4 Delete File
- **Opcode Character:** `X`
- **Operands:** None if used as a standalone line. If integrated into the header (`X--`), it takes no further operands on that line.
- **Example (standalone):** `X` (within a patch with `--- path/to/delete.txt` and `+++ /dev/null` headers)
- **Example (header integrated):** `X-- path/to/delete.txt` (the `+++` line is optional)
- **Description:** Indicates that the file specified should be deleted. If header-integrated (`X-- path`), the `+++ [path]` line is optional (if omitted, it implies deletion to non-existence). If `+++` is present with `X--`, it should typically be `/dev/null`. If `X` is used as a standalone opcode line, it applies to the file defined by the standard `---` and `+++` headers of its patch. Other line-level opcodes in a patch with a file deletion are typically redundant.

#### 5.3.5 Append to Start
- **Opcode Character:** `[`
- **Operands:** `[Content to prepend]`
    - `Content to prepend`: The content to add at the very beginning of the file. Newline characters within the content should be represented by the escape sequence `\n`. Literal `\n` sequences in the original content must be escaped as `\\n`.
- **Example:** `[Header line 1\\nHeader line 2` (Prepend two lines to the file, including a newline).
- **Description:** Appends the specified content to the beginning of the file.

#### 5.3.6 Append to End
- **Opcode Character:** `]`
- **Operands:** `[Content to append]`
    - `Content to append`: The content to add at the very end of the file. Newline characters within the content should be represented by the escape sequence `\n`. Literal `\n` sequences in the original content must be escaped as `\\n`.
- **Example:** `]Footer line 1\\nFooter line 2` (Append two lines to the file, including a newline).
- **Description:** Appends the specified content to the end of the file.

#### 5.3.7 Move/Rename File
- **Opcode Character:** `<`
- **Operands (standalone):** `[Old File Path]:[New File Path]`
- **Operands (header integrated):** None on the opcode line itself; paths are taken from the `---` and `+++` headers.
    - `Old File Path`: (For standalone) The path of the original file. Special characters (`:`, `<`, `\`) must be escaped.
    - `New File Path`: (For standalone) The path of the destination file. Special characters (`:`, `<`, `\`) must be escaped.
- **Example (standalone):** `<old/path/file.txt:new/location/renamed_file.txt`
- **Example (header integrated):**
  `<-- a/old/path/file.txt`
  `+++ b/new/location/file.txt`
- **Description:** Indicates that a file has been moved or renamed. If header integrated (`<--`), the `---` path is the old path and `+++` is the new path. Both header lines are required. If standalone, the operands specify old and new paths. Typically, this is accompanied by a separate `X` (Delete File) operation for the old path if it no longer exists after the move.

#### 5.3.8 Copy Block from Original
- **Opcode Character:** `=`
- **Operands:** `[Original Start Line],[Count]:[Insertion Line Number]`
    - `Original Start Line`: The 1-indexed line number in the *original* version of the file from which to start copying.
    - `Count`: The number of lines to copy from the original file.
    - `Insertion Line Number`: The 1-indexed line number *before* which the copied block should be inserted in the *current* version of the file being patched. Lines at and after this number are shifted down after insertion.
- **Example:** `=20,10:5` (Copy 10 lines starting from line 20 of the original file and insert them before line 5 of the current file being patched).
- **Description:** Copies a block of lines from the original version of the file being patched and inserts them into the current version at the specified insertion line number. This opcode is an optimization for representing unchanged blocks of lines.

#### 5.3.9 Copy Block from Another File
- **Opcode Character:** `&`
- **Operands:** `[Source File Path]:[Source Start Line],[Count]:[Insertion Line Number]`
    - `Source File Path`: The path of the file from which to copy lines, relative to the repository root. Special characters (`:`, `,`, `>`, `&`, `\`, `<`) must be escaped with a preceding backslash.
    - `Source Start Line`: The 1-indexed line number in the *source* file from which to start copying.
    - `Count`: The number of lines to copy from the source file.
    - `Insertion Line Number`: The 1-indexed line number *before* which the copied block should be inserted in the *current* version of the file being patched. Lines at and after this number are shifted down after insertion.
- **Example:** `&path/to/source.txt:15,10:5` (Copy 10 lines starting from line 15 of src/utils.py, insert before line 5 in src/main.py).
- **Description:** Copies a block of lines from a specified source file and inserts them into the current file being patched at the specified insertion line number. This opcode is used to represent content moves or copies between files.

#### 5.3.10 Delete Lines from Start
- **Opcode Character:** `(`
- **Operands:** `[Count]`
    - `Count`: The number of lines to delete from the beginning of the file.
- **Example:** `(5` (Delete the first 5 lines of the file).
- **Description:** Deletes a specified number of lines starting from the first line of the file.

#### 5.3.11 Delete Lines from End
- **Opcode Character:** `)`
- **Operands:** `[Count]`
    - `Count`: The number of lines to delete from the end of the file.
- **Example:** `)3` (Delete the last 3 lines of the file).
- **Description:** Deletes a specified number of lines from the end of the file.

#### 5.3.12 Copy File
- **Opcode Character:** `+`
- **Operands (standalone):** `[Source File Path]:[Destination File Path]`
- **Operands (header integrated):** None on the opcode line itself; paths are taken from the `---` and `+++` headers.
    - `Source File Path`: (For standalone) The path of the file to copy from. Special characters must be escaped.
    - `Destination File Path`: (For standalone) The path where the file should be copied to. Special characters must be escaped.
- **Example (standalone):** `+templates/default.html:src/pages/about.html`
- **Example (header integrated):**
  `+-- a/templates/base.html`
  `+++ b/src/index.html`
- **Description:** Creates a new file at `Destination File Path` with the exact content of the file at `Source File Path`. If header integrated (`+--`), `---` is the source path and `+++` is the destination. Both header lines are required. If standalone, operands specify source and destination. This opcode typically appears as the only operation within a patch for the destination file path.

### 5.4 Reserved Opcodes
The following single non-alphanumeric characters are reserved for future use. Their behavior is currently undefined and parsers should ignore lines starting with these characters or treat them as errors.

`%`, `*`, `{`, `}`, `|`, `;`, `'`, `"`, `,`, `.`, `?`, `/`, `~`

(This list can be expanded to include any unused non-alphanumeric ASCII characters).

### 5.5 Gdiff Document Structure and Processing
A Gdiff Document is a concatenation of one or more plaintext patches. Patches are identified by lines starting with `--- ` or by a file-level opcode character followed by `-- ` (e.g., `X-- `, `<-- `, `+-- `). An interpreter reads the document line by line. When such a header line is encountered, a new patch begins. Subsequent lines starting with a defined opcode character are processed as operations on the relevant file(s) until the start of the next patch or the end of the document is reached. The order of patches in the document typically corresponds to the order of files in the original diff, and the order of opcode lines within a patch is the order in which operations should be applied.

### 5.6 Escape Mechanisms
Within operands, the backslash character (\`) is used as an escape character. To include a literal backslash, colon (`:`), or comma (`,`) within an operand where it would otherwise be interpreted as a delimiter or the escape character itself, it must be escaped with a preceding backslash (e.g., `\\`, `\:`, `\,`).
Newline characters within content operands (for `!`, `@`, `^`, and `$` opcodes) must be represented by the escape sequence `\n`. Literal `\n` sequences in the original content must be escaped as `\\n`.

### 5.7 Error Handling
Parsers and apply tools for gdiff should consider the following types of errors:
- **Syntax Errors:** Lines that do not conform to the expected opcode and operand format, or incorrect escape sequences. Parsers could ignore malformed lines, log warnings/errors, or abort processing.
- **Unknown Opcodes:** Lines starting with a character not defined in the Opcodes section or Reserved Opcodes list. These should typically be ignored or flagged as errors.
- **Invalid Operands:** Operands that are missing, incorrectly formatted (e.g., non-integer where integer is expected), or out of valid range (e.g., line numbers exceeding file bounds). Application tools should define behavior for out-of-bounds operations (e.g., aborting the patch, attempting best-effort application).
- **Application Errors:** Issues encountered when applying a patch to a file, such as the target file not existing (unless it's a creation), line numbers not matching the expected state, or conflicts between operations. Robust tools should report these errors and potentially provide options for resolution or partial application.
- **Header `a/` and `b/` Prefixes:** `a/` and `b/` prefixes are required in the `---` and `+++` header lines for patches representing traditional git operations (modify/add, delete, move/rename, copy). Parsers must expect and validate these prefixes in headers. Paths used within opcode operands (e.g., the source path in the `&` opcode) must *not* include `a/` or `b/` prefixes.

### 5.8 Examples

Here are a few examples illustrating how gdiff can represent common file changes.

#### Example 1: Adding lines

```gdiff
--- a/src/file.txt
+++ b/src/file.txt
!3:This is a new line after line 2.
!1:This line is inserted at the very beginning.
```
Explanation: This is a patch for `src/file.txt`. Inserts "This line is inserted at the very beginning." before the original line 1, then inserts "This is a new line after line 2." before the line that is now the 3rd line (originally line 2). The order of opcodes matters.

#### Example 2: Deleting lines

```gdiff
--- a/src/file.txt
+++ b/src/file.txt
(-5 (Delete the first 5 lines using the specific opcode)
-10,2 (Delete 2 lines starting from the line that is currently the 10th)
```
Explanation: This is a patch for `src/file.txt`. Deletes the first 5 lines. Then, operating on the file after the first deletion, deletes 2 lines starting from the line that is now the 10th.

#### Example 3: Modifying a line

```gdiff
--- a/src/file.txt
+++ b/src/file.txt
@8:This is the modified content for line 8.
```
Explanation: This is a patch for `src/file.txt`. Replaces the content of the 8th line with "This is the modified content for line 8.".

#### Example 4: Renaming a file

```gdiff
<-- a/old/path/config.yml
+++ b/new/location/settings.yml
```
Explanation: Indicates that `old/path/config.yml` is renamed to `new/location/settings.yml`, using the header-integrated `<` opcode. Note the `a/` and `b/` prefixes on the respective paths.

#### Example 5: Appending to start and end

```gdiff
--- a/src/data.csv
+++ b/src/data.csv
[id,name,value\n
]EOF\n
```
Explanation: This is a patch for `src/data.csv`. Prepends the header line "id,name,value" followed by a newline to the file. Then appends "EOF" followed by a newline to the end of the file.

#### Example 6: Copying a block from the original file

```gdiff
--- a/src/report.md
+++ b/src/report.md
=20,10:5 (Copy lines 20-29 from original, insert before current line 5)
```
Explanation: This is a patch for `src/report.md`. Takes the block of 10 lines starting from line 20 in the *original* version of `src/report.md` and inserts them into the *current* version of `src/report.md` before the line that is currently the 5th line.

#### Example 7: Copying a block from another file

```gdiff
--- a/src/main.py
+++ b/src/main.py
&src/utils.py:15,10:5 (Copy 10 lines starting from line 15 of src/utils.py, insert before line 5 in src/main.py)
```
Explanation: This is a patch for `src/main.py`. Takes the block of 10 lines starting from line 15 in `src/utils.py` (note no `a/` or `b/` prefix on the source file path in the operand) and inserts them into `src/main.py` before the line that is currently the 5th line.

#### Example 8: Deleting a file

```gdiff
--- a/old/file.log
+++ b//dev/null
X
```
Explanation: Deletes `old/file.log` using the standalone `X` opcode. Note the `a/` prefix on the old path and `b//dev/null` on the new path.

Alternatively, using header integration (most concise for deletion):
```gdiff
X-- a/old/file.log
+++ b//dev/null
```
Explanation: Deletes `old/file.log` using the header-integrated `X` opcode. Note the `a/` and `b//dev/null` prefixes.

If the `+++` line is omitted with header integration:
```gdiff
X-- a/old/file.log
```
Explanation: Deletes `old/file.log` using header-integrated `X` with the `+++` line omitted, implying deletion to non-existence. Note the `a/` prefix.

#### Example 9: Copying a file (header-integrated)

```gdiff
+-- a/templates/base.html
+++ b/src/index.html
```
Explanation: Copies the content of `templates/base.html` to a new file `src/index.html`, using the header-integrated `+` opcode. Note the `a/` and `b/` prefixes on the source and destination paths.

## 6. Design Considerations

- **Plaintext Format:** Human readability is improved compared to a binary format. However, parsing requires line-by-line processing and careful handling of operands, especially content containing special characters (like `:` in Add/Modify or newlines in Append). Size efficiency might be lower than a binary format.
- **Escape Mechanisms:** Introducing escape mechanisms adds complexity to parsing and generation of gdiff documents. It is necessary for handling special characters and multiline content in a plaintext format but requires careful implementation to avoid errors.
- **Single Character Opcodes:** Simple and easy to identify. Limits the total number of unique opcodes to the available non-alphanumeric characters.
- **Operand Encoding (Plaintext):** Operands are human-readable. Requires careful definition of delimiters (like `:` and `,`) and potential escape mechanisms if operand content can contain these delimiters. Newlines within appended content need a defined representation or handling.
- **Opcode Granularity:** The current opcodes are line-based or file-based. This provides more granularity than simple hunk-based diffs but is still relatively straightforward. More advanced operations (like copying/moving blocks or inline changes) would require new opcodes.
- **Order of Operations within a Patch:** The sequential order of opcode lines within a patch is critical. Add and delete operations alter line numbers for subsequent operations. Parsers must apply operations in order.
- **File Identification and Headers:** Patches are identified by `--- [path]` and `+++ [path]` headers. These headers include `a/` and `b/` prefixes for patches representing traditional git operations (modify/add, delete, move/rename, copy) to leverage familiarity. Paths used as operands within opcode lines (like in the `&` opcode) do not include these prefixes and are typically relative to the repository root. Header lines can optionally be prefixed by a file-level opcode (`X`, `<`, `+`) using the `Opcode--` syntax.
- **Balancing Clarity and Density:** In some cases (e.g., the optional `+++ b//dev/null` line for deletions), redundant data is allowed or recommended in the canonical format to improve human readability and clarity, aligning with the goal of retaining human readability. However, parsers and generators may support a 'minified' format where such redundancy is omitted for maximum density when human readability is less critical.
- **Header-Integrated Opcodes:** Allowing file-level opcodes (`X`, `<`, `+`) to optionally prefix the `---` header line offers conciseness using the `Opcode--` syntax. Parsers must check for an optional opcode character before the standard `---` marker. `a/` and `b/` prefixes must be present on the paths in these header lines and the corresponding `+++` line (if required by the operation), based on whether the patch represents a standard file operation.
- **Error Handling:** A plaintext format is susceptible to parsing errors due to malformed lines or incorrect operands. The specification defines how parsers should handle such errors (e.g., skip the line, abort the patch, abort the document).
- **Extensibility:** New opcodes can be added using the reserved non-alphanumeric characters, providing a degree of future-proofing.
- **Binary Files:** This plaintext, line-based format is not suitable for binary files. A separate mechanism or format would be needed for binary diffs.
- **File Creation:** File creation is handled by a patch where the `---` header indicates a non-existent file (e.g., `a//dev/null`) and the `+++` header indicates the new file path (e.g., `b/src/new_file.txt`), combined with opcodes to add content. The `+` (Copy File) opcode also facilitates creation from an existing source.

## 7. Future Work
- Specify error handling behavior for parsers. (Addressed in 5.7, but further refinement is possible)
- Develop tools for generating gdiff from git diffs and applying gdiff patches.
- **Tooling:** Developing robust tools for generating gdiff documents from existing source control diffs (like git diff) and for applying gdiff patches to files is essential for the practical usability of this format. These tools will need to handle parsing, escape sequences, opcode logic, and error conditions. 
