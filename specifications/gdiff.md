# **White Paper: gdiff**
### An Opcodeized Git Diff Specification

**Version:** 1.0.0  
**Date:** July 9, 2025  
**Authors:** N Lisowski

---

## 1. Introduction

This document specifies the gdiff format, an opcodeized, plaintext representation of changes to files. While retaining human readability, its primary goal is to provide a more machine-readable structure and offer more nuance and targeted changes compared to the standard text-based diff format, particularly those generated by Git.

## 2. Goals

- Define a structured, plaintext format that provides a machine-readable and granular representation of file changes, going beyond traditional line-based diffs.
- Balance familiarity with existing diff formats for common operations with the flexibility to introduce new, targeted opcodes.
- Retain a degree of human readability for ease of review and understanding.
- Serve as a robust, data-oriented basis for tools and applications to generate, parse, and apply file changes programmatically.

## 3. Non-Goals

- Entirely replacing the standard git diff format (gdiff is an alternative representation). Tooling may be developed to convert between formats.
- Implementing a full git client.
- Handling complex merge conflicts within the gdiff format itself (though it can represent the changes leading to them).
- Supporting binary file diffs (this is a line-based, plaintext format).

## 4. Concepts

- **Opcode:** A single non-alphanumeric character representing a specific type of change (e.g., `!`, `-`, `@`).
- **Operand:** Data associated with an opcode, provided in plaintext after the opcode character.
- **Patch:** A block of text representing the changes to a single file (or the relationship between two files in cases like renames or copies), beginning with file identification headers (`---` and `+++`).
- **Gdiff Document:** A concatenation of plaintext patches, representing the changes across multiple files.

## 5. Protocol Specification

This section details the specific opcodes, their plaintext operands, and the overall structure of a gdiff document. The document is a sequence of concatenated plaintext patches. Each patch targets a specific file and contains a sequence of opcode lines.

### 5.1 Versioning

A gdiff document **must** begin with a version line to indicate the specification version it adheres to. The format of the version line is:

```
gdiff-version: [major].[minor]
```

For this version of the specification, the version is `1.0`. Parsers should read this line first to understand the expected format of the rest of the document. Documents without a version line should be treated as invalid.

### 5.2 Patch Structure

A patch begins with file identification headers (`---` and `+++`). These headers are used to identify the file(s) being changed.

To align with common diff formats used in version control systems like Git for traditional file operations (modify/add, delete, move/rename, copy), these headers include `a/` and `b/` prefixes. The `a/` prefix conventionally indicates the "before" state or source file path, and the `b/` prefix indicates the "after" state or destination file path.

For modify/add patches, which represent changes to a single file from a "before" to an "after" state, both `---` and `+++` lines will typically refer to the same file path, prefixed with `a/` and `b/` respectively.

For file-level operations like Delete (`X`), Move/Rename (`<`), or Copy (`+`), the opcode character may optionally be integrated directly into the `---` header line, replacing the first hyphen (`-`). The format becomes `[Opcode]-- [path]`. In these cases, the path on the `[Opcode]--` line will be prefixed with `a/` (representing the source or before state), and the path on the `+++` line (if present) will be prefixed with `b/` (representing the destination or after state).

**Important:** Paths provided as operands within the body of the patch (e.g., the source file path in the `&` opcode for copying from another file) must **not** include `a/` or `b/` prefixes. These internal paths are relative to the repository root and follow gdiff's internal conventions.

#### Header Structure Examples

**Standard Patch (Modify/Add):**
```
--- a/path/to/file.txt
+++ b/path/to/file.txt
```

**Delete File:**
```
X-- a/path/to/file_to_delete.txt
+++ b//dev/null
```
*(The `+++` line may be omitted for brevity)*

**Move/Rename File:**
```
<-- a/old/path/file.txt
+++ b/new/location/file.txt
```
*(Both `---` and `+++` lines are required)*

**Copy File:**
```
+-- a/source/file.txt
+++ b/destination/file.txt
```
*(Both `---` and `+++` lines are required)*

When an opcode is integrated into the header, a separate opcode line for that specific file-level action in the body of the patch is not needed.

Optionally, a context line similar to `@@ -old_start,old_count +new_start,new_count @@ [context]` may follow, though its parsing and use is implementation-dependent and primarily for human readability.

Following the headers (and optional context line), a sequence of opcode lines represents the changes to the file. Each opcode line starts with a single non-alphanumeric opcode character.

### 5.3 Opcodes

Below is a summary table of all defined opcodes:

| Opcode | Name/Action                | Operand Format / Header Integration         | Description                                                      |
|--------|----------------------------|---------------------------------------------|------------------------------------------------------------------|
| `!`    | Add Line                   | `[Line Number]:[Line Content]`              | Insert a new line before the given line number                   |
| `-`    | Delete Line(s)             | `[Start Line Number],[Count]`               | Delete a number of lines starting from the given line            |
| `@`    | Modify Line                | `[Line Number]:[New Line Content]`          | Replace the content of a line                                    |
| `X`    | Delete File                | None (standalone) or `X--` in header        | Delete the specified file                                        |
| `[`    | Append to Start            | `[Content to prepend]`                      | Prepend content to the beginning of the file                     |
| `]`    | Append to End              | `[Content to append]`                       | Append content to the end of the file                            |
| `<`    | Move/Rename File           | `[Old]:[New]` (standalone) or `<--` header  | Move or rename a file                                            |
| `=`    | Copy Block from Original   | `[Orig Start],[Count]:[Insert Line]`        | Copy block from original file version                            |
| `&`    | Copy Block from Another    | `[Src Path]:[Src Start],[Count]:[Insert]`   | Copy block from another file                                     |
| `(`    | Delete Lines from Start    | `[Count]`                                   | Delete lines from the beginning of the file                      |
| `)`    | Delete Lines from End      | `[Count]`                                   | Delete lines from the end of the file                            |
| `+`    | Copy File                  | `[Src]:[Dest]` (standalone) or `+--` header | Copy a file to a new location                                    |

#### 5.3.1 Add Line
- **Opcode Character:** `!`
- **Operands:** `[Line Number]:[Line Content]`
  - `Line Number`: The 1-indexed line number *before* which the new line should be inserted. Lines are shifted down after insertion.
  - `Line Content`: The content of the line to add. Special characters must be escaped according to Section 5.6.
- **Example:** `!5:This is a new line`
- **Description:** Inserts a new line with the specified content before the given line number in the target file.

#### 5.3.2 Delete Line(s)
- **Opcode Character:** `-`
- **Operands:** `[Start Line Number],[Count]`
  - `Start Line Number`: The 1-indexed line number of the first line to delete.
  - `Count`: The number of lines to delete starting from `Start Line Number`. A count of `1` deletes only the specified line.
- **Example:** `-10,3`
- **Description:** Deletes a specified number of lines starting from the `Start Line Number`.

#### 5.3.3 Modify Line
- **Opcode Character:** `@`
- **Operands:** `[Line Number]:[New Line Content]`
  - `Line Number`: The 1-indexed line number of the line to modify.
  - `New Line Content`: The new content for the specified line. Special characters must be escaped according to Section 5.6.
- **Example:** `@7:Modified content here`
- **Description:** Replaces the content of the line at `Line Number` with `New Line Content`.

#### 5.3.4 Delete File
- **Opcode Character:** `X`
- **Operands:** None if used as a standalone line. If integrated into the header (`X--`), it takes no further operands.
- **Example (standalone):** `X`
- **Example (header integrated):** `X-- a/path/to/delete.txt`
- **Description:** Indicates that the file specified should be deleted. If header-integrated (`X--`), the `+++` line is optional (if omitted, it implies deletion to non-existence). If present, it should typically be `b//dev/null`.

#### 5.3.5 Append to Start
- **Opcode Character:** `[`
- **Operands:** `[Content to prepend]`
  - `Content to prepend`: The content to add at the very beginning of the file. Newline characters within the content should be represented by `\n`. Literal backslashes and newlines must be escaped according to Section 5.6.
- **Example:** `[Header line 1\nHeader line 2\n`
- **Description:** Prepends the specified content to the beginning of the file.

#### 5.3.6 Append to End
- **Opcode Character:** `]`
- **Operands:** `[Content to append]`
  - `Content to append`: The content to add at the very end of the file. Newline characters within the content should be represented by `\n`. Literal backslashes and newlines must be escaped according to Section 5.6.
- **Example:** `]Footer line 1\nFooter line 2\n`
- **Description:** Appends the specified content to the end of the file.

#### 5.3.7 Move/Rename File
- **Opcode Character:** `<`
- **Operands (standalone):** `[Old File Path]:[New File Path]`
- **Operands (header integrated):** None on the opcode line itself; paths are taken from the `---` and `+++` headers.
  - `Old File Path`: (For standalone) The path of the original file. Special characters must be escaped according to Section 5.6.
  - `New File Path`: (For standalone) The path of the destination file. Special characters must be escaped according to Section 5.6.
- **Example (standalone):** `<old/path/file.txt:new/location/renamed_file.txt`
- **Example (header integrated):**
  ```
  <-- a/old/path/file.txt
  +++ b/new/location/file.txt
  ```
- **Description:** Indicates that a file has been moved or renamed. If header integrated (`<--`), both header lines are required.

#### 5.3.8 Copy Block from Original
- **Opcode Character:** `=`
- **Operands:** `[Original Start Line],[Count]:[Insertion Line Number]`
  - `Original Start Line`: The 1-indexed line number in the *original* version of the file from which to start copying.
  - `Count`: The number of lines to copy from the original file.
  - `Insertion Line Number`: The 1-indexed line number *before* which the copied block should be inserted in the *current* version of the file being patched.
- **Example:** `=20,10:5`
- **Description:** Copies a block of lines from the original version of the file being patched and inserts them into the current version at the specified insertion line number.

#### 5.3.9 Copy Block from Another File
- **Opcode Character:** `&`
- **Operands:** `[Source File Path]:[Source Start Line],[Count]:[Insertion Line Number]`
  - `Source File Path`: The path of the file from which to copy lines, relative to the repository root. Must **not** include `a/` or `b/` prefixes. Special characters must be escaped according to Section 5.6.
  - `Source Start Line`: The 1-indexed line number in the *source* file from which to start copying.
  - `Count`: The number of lines to copy from the source file.
  - `Insertion Line Number`: The 1-indexed line number *before* which the copied block should be inserted in the *current* version of the file being patched.
- **Example:** `&path/to/source.txt:15,10:5`
- **Description:** Copies a block of lines from a specified source file and inserts them into the current file being patched at the specified insertion line number.

#### 5.3.10 Delete Lines from Start
- **Opcode Character:** `(`
- **Operands:** `[Count]`
  - `Count`: The number of lines to delete from the beginning of the file.
- **Example:** `(5`
- **Description:** Deletes a specified number of lines starting from the first line of the file.

#### 5.3.11 Delete Lines from End
- **Opcode Character:** `)`
- **Operands:** `[Count]`
  - `Count`: The number of lines to delete from the end of the file.
- **Example:** `)3`
- **Description:** Deletes a specified number of lines from the end of the file.

#### 5.3.12 Copy File
- **Opcode Character:** `+`
- **Operands (standalone):** `[Source File Path]:[Destination File Path]`
- **Operands (header integrated):** None on the opcode line itself; paths are taken from the `---` and `+++` headers.
  - `Source File Path`: (For standalone) The path of the file to copy from. Special characters must be escaped according to Section 5.6.
  - `Destination File Path`: (For standalone) The path where the file should be copied to. Special characters must be escaped according to Section 5.6.
- **Example (standalone):** `+templates/default.html:src/pages/about.html`
- **Example (header integrated):**
  ```
  +-- a/templates/base.html
  +++ b/src/index.html
  ```
- **Description:** Creates a new file at `Destination File Path` with the exact content of the file at `Source File Path`. If header integrated (`+--`), both header lines are required.

### 5.4 Reserved Opcodes

The following single non-alphanumeric characters are reserved for future use. Their behavior is currently undefined and parsers should treat lines starting with these characters as errors:

`%`, `*`, `{`, `}`, `|`, `;`, `'`, `"`, `,`, `.`, `?`, `/`, `~`, `^`, `$`, `#`

### 5.5 Gdiff Document Structure and Processing

A Gdiff Document is a concatenation of one or more plaintext patches, preceded by a mandatory version line. Patches are identified by lines starting with `--- ` or by a file-level opcode character followed by `-- ` (e.g., `X-- `, `<-- `, `+-- `). 

An interpreter reads the document line by line. After processing the version line, when a header line is encountered, a new patch begins. Subsequent lines starting with a defined opcode character are processed as operations on the relevant file(s) until the start of the next patch or the end of the document is reached. 

The order of patches in the document typically corresponds to the order of files in the original diff, and the order of opcode lines within a patch is the order in which operations should be applied.

### 5.6 Escape Mechanisms

Within operands, the backslash character (`\`) is used as an escape character:

- To include a literal backslash: `\\`
- To include a literal colon: `\:`
- To include a literal comma: `\,`
- To represent a newline character: `\n`
- To include a literal `\n` sequence: `\\n`

All other characters following a backslash are treated literally (the backslash is preserved).

### 5.7 Error Handling

Parsers and application tools for gdiff should consider the following types of errors:

#### 5.7.1 Syntax Errors
Lines that do not conform to the expected opcode and operand format, or incorrect escape sequences. Parsers should abort processing and report the specific error.

#### 5.7.2 Unknown Opcodes
Lines starting with a character not defined in the Opcodes section or Reserved Opcodes list. These should be treated as errors and cause processing to abort.

#### 5.7.3 Invalid Operands
- Missing operands
- Incorrectly formatted operands (e.g., non-integer where integer is expected)
- Out of valid range operands (e.g., line numbers exceeding file bounds)

Application tools should abort the patch and report the specific error.

#### 5.7.4 Application Errors
Issues encountered when applying a patch to a file:
- Target file not existing (unless it's a creation operation)
- Line numbers not matching the expected state
- Conflicts between operations

Tools should report these errors with sufficient detail for debugging and resolution.

#### 5.7.5 Header Validation
- Missing required `a/` and `b/` prefixes in header lines
- Malformed header structure
- Missing required `+++` lines for certain operations

Parsers must validate header structure and report errors for non-conforming headers.

### 5.8 Examples

#### Example 1: Complete Document with Version and Multiple Patches

```gdiff
gdiff-version: 1.0
--- a/src/file.txt
+++ b/src/file.txt
!1:This line is inserted at the very beginning.
!4:This is a new line after original line 2.
@8:This is modified content for line 8.

--- a/config/settings.yml
+++ b/config/settings.yml
(2
]# Added by gdiff\n
```

#### Example 2: File Operations

```gdiff
gdiff-version: 1.0
<-- a/old/path/config.yml
+++ b/new/location/settings.yml

X-- a/temp/old_file.log
+++ b//dev/null

+-- a/templates/base.html
+++ b/src/index.html
```

#### Example 3: Advanced Content Operations

```gdiff
gdiff-version: 1.0
--- a/src/main.py
+++ b/src/main.py
&src/utils.py:15,10:5
=20,5:25
[#!/usr/bin/env python3\n# Main application\n\n
]# End of file\n
```

## 6. Design Considerations

### 6.1 Plaintext Format
Human readability is prioritized while maintaining machine parseability. The format requires careful handling of special characters and escape sequences but provides transparency in diff operations.

### 6.2 Single Character Opcodes
Simple identification with single non-alphanumeric characters provides clear operation semantics while limiting the total number of unique opcodes to available characters.

### 6.3 Line-Based Operations
The current opcodes operate at line or file level, providing more granularity than hunk-based diffs while maintaining simplicity. Character-level operations would require additional opcodes.

### 6.4 Header Compatibility
Using `a/` and `b/` prefixes in headers maintains compatibility with existing git tooling expectations while clearly distinguishing header paths from operand paths.

### 6.5 Order Dependency
The sequential nature of operations within a patch is critical, as add/delete operations alter line numbers for subsequent operations. This design choice enables precise change specification but requires careful application order.

### 6.6 Extensibility
Reserved opcodes provide future extensibility while maintaining backward compatibility for parsers that understand how to handle unknown opcodes.

## 7. Implementation Guidelines

### 7.1 Parser Requirements
- Must validate version line as first non-empty line
- Must support all defined opcodes
- Must properly handle escape sequences
- Must validate header structure and prefixes
- Should provide detailed error reporting

### 7.2 Generator Requirements
- Must emit proper version line
- Must use correct header format with appropriate prefixes
- Must properly escape special characters in operands
- Should optimize operation order for efficiency

### 7.3 Application Tool Requirements
- Must apply operations in the specified order
- Must handle line number adjustments correctly
- Must provide meaningful error messages for failed operations
- Should support dry-run mode for validation

## 8. Future Work

- **Binary File Support:** Develop companion specification for binary file diffs
- **Tooling Development:** Create robust tools for converting between git diff and gdiff formats
- **Performance Optimization:** Investigate optimized parsing and application strategies
- **Advanced Operations:** Consider character-level or semantic-level opcodes for finer granularity
- **Compression:** Explore optional compression schemes for large gdiff documents
- **Validation Tools:** Develop tools for validating gdiff document correctness and consistency

## 9. Conclusion

The gdiff specification provides a structured, extensible format for representing file changes with enhanced machine readability while maintaining human interpretability. Its opcode-based approach enables precise, granular change specification that goes beyond traditional line-based diff formats, making it suitable for automated tools and applications requiring detailed change analysis and application.

The specification balances familiarity with git conventions and the flexibility needed for advanced diff operations, providing a solid foundation for next-generation change management tools.